<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8'>
  <title>WebRTC Demo</title>
  <style>
    textarea {
      width: 100%;
      height: 300px;
    }

    .panel {
      display: flex;
      column-gap: 1em;
      width: 100%;
    }

    .step {
      width: 100%;
    }

    .video-player {
      border: 2px solid greenyellow;
      background-color: rgb(63, 62, 62);
      width: 500px;
    }
  </style>
</head>

<body>
  <div>
    <h2>WebRTC, Passing SDP with no signaling.</h2>
    <p><b>Instructions: </b>
      Start by opening two tabs side by side and follow the steps below to pass SDP offer and answer.
      I will refer to each tab as <i><b>User 1</b></i> and <i><b>User 2</b></i>.
    </p>
  </div>

  <div class="panel">
    <video class="video-player" id="user-1" autoplay playsinline></video>
    <video class="video-player" id="user-2" autoplay playsinline></video>
  </div>

  <p>
    <strong>Step 1:User 1 & 2:</strong>
    <button onclick="init()">Initialize</button>
  </p>
  <p>
    <strong>Step 2:</strong>
    User 1, click <button id="create-offer" onclick="createOffer()">Create Offer & Copy to clipboard</button>
    to generate SDP offer and copy offer from text area below.
  </p>
  <p>
    <strong>Step 3:</strong>
    User 2, paste SDP offer generated by user 1 into text area above, then click
    <button id="create-answer" onclick="createAnswer()">Create answer & Copy to clipboard</button>
    to generate SDP answer and copy the answer from the text area below.
  </p>
  <p>
    <strong>Step 4:</strong>
    User 1, paste SDP offer generated by user 2 into text area above and then click
    <button id="add-answer" onclick="addAnswer()">Add answer</button>.
  </p>

  <div class="panel">
    <div class="step">
      <label for="offer-sdp">SDP OFFER:</label>
      <textarea id="offer-sdp" placeholder='User 2, paste SDP offer here...'></textarea>
    </div>

    <div class="step">
      <label for="answer-sdp">SDP Answer:</label>
      <textarea id="answer-sdp" placeholder="User 1, paste SDP answer here..."></textarea>
    </div>
  </div>
</body>
<script>
  let peerConnection = null;
  let localStream = null;
  let remoteStream = null;
  const offerTextArea = document.getElementById('offer-sdp');
  const answerTextArea = document.getElementById('answer-sdp');

  let init = async () => {
    offerTextArea.value = "";
    answerTextArea.value = "";
    if (peerConnection != null) {
      peerConnection.close();
    }
    if (localStream != null) {
      localStream.getTracks().forEach(track => track.stop());
    }
    if (remoteStream != null) {
      remoteStream.getTracks().forEach(track => track.stop());
    }
    peerConnection = new RTCPeerConnection();
    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false })
    remoteStream = new MediaStream();
    document.getElementById('user-1').srcObject = localStream
    document.getElementById('user-2').srcObject = remoteStream;

    localStream.getTracks().forEach((track) => {
      peerConnection.addTrack(track, localStream);
    });

    peerConnection.ontrack = (event) => {
      event.streams[0].getTracks().forEach((track) => {
        remoteStream.addTrack(track);
      });
    };
  }

  function onIceFor(textArea) {
    return async event => {
      if (event.candidate) {
        textArea.value = JSON.stringify(peerConnection.localDescription);
        navigator.clipboard.writeText(textArea.value);
      }
    }
  }

  let createOffer = async () => {
    peerConnection.onicecandidate = onIceFor(offerTextArea);
    const offer = await peerConnection.createOffer();
    await peerConnection.setLocalDescription(offer);
  }

  let createAnswer = async () => {
    let offer = JSON.parse(offerTextArea.value)
    peerConnection.onicecandidate = onIceFor(answerTextArea);
    await peerConnection.setRemoteDescription(offer);
    let answer = await peerConnection.createAnswer();
    await peerConnection.setLocalDescription(answer);
  }

  let addAnswer = async () => {
    let answer = JSON.parse(answerTextArea.value);
    if (!peerConnection.currentRemoteDescription) {
      peerConnection.setRemoteDescription(answer);
    }
  }

</script>

</html>