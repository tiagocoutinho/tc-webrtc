<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8'>
  <title>WebRTC Demo</title>
  <style>
    textarea {
      width: 100%;
      height: 300px;
    }

    .panel {
      display: flex;
      column-gap: 1em;
      width: 100%;
    }

    .step {
      width: 100%;
    }

    .video-player {
      border: 2px solid greenyellow;
      background-color: rgb(63, 62, 62);
      width: 400px;
    }
  </style>
</head>

<body>
  <div>
    <h2>WebRTC, Passing SDP with no signaling.</h2>
    <p><b>Instructions: </b>
      Start by opening two tabs side by side and follow the steps below to pass SDP offer and answer. I will refer to
      each tab as
      <i><b>User 1</b></i> and <i><b>User 2</b></i>.
    </p>
  </div>

  <div class="panel">
    <video class="video-player" id="user-1" autoplay playsinline></video>
    <video class="video-player" id="user-2" autoplay playsinline></video>
  </div>

  <p>
    <strong>Step 1:</strong>
    User 1, click <button id="create-offer">Create Offer & Copy to clipboard</button>
    to generate SDP offer and copy offer from text area below.
  </p>
  <p>
    <strong>Step 2:</strong>
    User 2, paste SDP offer generated by user 1 into text area above, then click
    <button id="create-answer">Create answer & Copy to clipboard</button>
    to generate SDP answer and copy the answer from the text area below.
  </p>
  <p>
    <strong>Step 3:</strong>
    User 1, paste SDP offer generated by user 2 into text area above and then click
    <button id="add-answer">Add answer</button>.
  </p>

  <div class="panel">
    <div class="step">
      <label for="offer-sdp">SDP OFFER:</label>
      <textarea id="offer-sdp" placeholder='User 2, paste SDP offer here...'></textarea>
    </div>

    <div class="step">
      <label for="answer-sdp">SDP Answer:</label>
      <textarea id="answer-sdp" placeholder="User 1, paste SDP answer here..."></textarea>
    </div>
  </div>
</body>
<script>
  let peerConnection = new RTCPeerConnection()
  let localStream;
  let remoteStream;

  let init = async () => {
    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false })
    remoteStream = new MediaStream()
    document.getElementById('user-1').srcObject = localStream
    document.getElementById('user-2').srcObject = remoteStream

    localStream.getTracks().forEach((track) => {
      peerConnection.addTrack(track, localStream);
    });

    peerConnection.ontrack = (event) => {
      event.streams[0].getTracks().forEach((track) => {
        remoteStream.addTrack(track);
      });
    };
  }

  let createOffer = async () => {
    peerConnection.onicecandidate = async (event) => {
      //Event that fires off when a new offer ICE candidate is created
      if (event.candidate) {
        const offer = JSON.stringify(peerConnection.localDescription);
        document.getElementById('offer-sdp').value = offer;
        navigator.clipboard.writeText(offer);
      }
    };

    const offer = await peerConnection.createOffer();
    await peerConnection.setLocalDescription(offer);
  }

  let createAnswer = async () => {
    let offer = JSON.parse(document.getElementById('offer-sdp').value)

    peerConnection.onicecandidate = async (event) => {
      //Event that fires off when a new answer ICE candidate is created
      if (event.candidate) {
        const answer = JSON.stringify(peerConnection.localDescription);
        document.getElementById('answer-sdp').value = answer;
        navigator.clipboard.writeText(answer);
      }
    };

    await peerConnection.setRemoteDescription(offer);

    let answer = await peerConnection.createAnswer();
    await peerConnection.setLocalDescription(answer);
  }

  let addAnswer = async () => {
    console.log('Add answer triggerd')
    let answer = JSON.parse(document.getElementById('answer-sdp').value)
    console.log('answer:', answer)
    if (!peerConnection.currentRemoteDescription) {
      peerConnection.setRemoteDescription(answer);
    }
  }

  init()

  document.getElementById('create-offer').addEventListener('click', createOffer)
  document.getElementById('create-answer').addEventListener('click', createAnswer)
  document.getElementById('add-answer').addEventListener('click', addAnswer)
</script>

</html>